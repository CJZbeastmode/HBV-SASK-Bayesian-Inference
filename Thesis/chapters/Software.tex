\chapter{Description of Software Implementation}
In this chapter, a brief documentation of the software implementation of this thesis is given. An overview of the structure will be documented, as well as how to use the implemented framework to perform Bayesian inference using different algorithms.

\section{Structure and Usage}
The repository\footnote{https://github.com/CJZbeastmode/HBV-SASK-Bayesian-Inference} contains three main subfolders. "Thesis" includes the source file of the actual thesis and "result" includes the benchmarked data and visualization for the thesis. The most important folder regarding the actual software is "implementation", where the implemented algorithm and the data are stored.

The structure of the algorithm is as follows: the main file that is executed is called "run.py" under the src subfolder. This file is responsible for calling the selected implemented algorithm and executing the Bayesian inference with specified parameters. Specifying the arguments that configure the run time environment can be done by editing the file "run\_config.json" on the root level. This file uses the JSON format to configure the run-time parameters of the software. The requirements or options are documented below:

\begin{itemize}
    \item configPath (required): the config file that is used for the model
    \item basis (required): the basis of the data that is used for the model
    \item mode (required): the mode of the algorithm, options: mh, parallel\_mh, gpmh, dream
    \item separate\_chains (optional, default=false): to determine whether the output file is supposed to record the data separately by chains, only relevant for algorithms that sample data using multiple chains, including parallel\_mh and dream
    \item burnin\_fac (optional, default=5): the burn in factor that is used for the result of the MCMC algorithm. The first 1/burnin\_fac percentage of the entire data is going to be discarded
    \item effective\_sample\_size (optional, default=1): only the every n\_th data is going to be collected. Default 1: no data point is going to be discarded
    \item output\_file\_name (optional, default="mcmc\_data.out"): the file name of the saved output result
    \item kwargs (optional): a dictionary in form of JSON that is used for specific algorithm input parameters
\end{itemize}

The first parameter, configPath, leads to another configuration file that is used for the hydrological model instantiation. This configuration file for the hydrological model is typically stored in the configuration subfolder under implementation.

After configuring the configuration file, we execute the software by running "run.py". The software then fetches the data from the configuration file, loading the model via model initialization files, which are "construction\_model.py" and "execute\_model.py", and selecting the corresponding algorithm and likelihood function. The algorithm initialization files are stored in the folder run\_mcmc, acting as a preparation for executing the actual algorithms, all of which are stored in the dependencies subfolder on the level before. The different implementations of likelihood functions are stored in the likelihood subfolder. The samples that are generated will be stored as a CSV file as output.

For the visualization part, the Jupyter notebook file "visualization.ipynb" is provided under the "src" folder. To configure the visualization, the file "viz\_config.json" is used. Individual parameters for configurations are listed below.

\begin{itemize}
    \item configPath (required): the config file that is used for the model
    \item basis (required): the basis of the data that is used for the model
    \item input\_file (required): the data in the input file. It could be seperately recorded or merged
    \item sep\_viz (optional, default=False): the option to visualize the data by chains. If false, then the entire dataframe is going to be visualized. If true, different chains are going to be visualized individually, before a comparison visualization is going to be given
    \item monte\_carlo\_repetition (optional, default=1000): the number of iterations for the monte carlo method for the comparison of the Bayesian inference result 
\end{itemize}

\section{Algorithm Specification}
As mentioned in the parameter explanation in the last section, "kwargs" indicate specific configurations for the Markov chain Monte Carlo algorithms. In this section, details regarding these specifications are documented.

Configurations for the fundamental Metropolis-Hastings algorithm include:
\begin{itemize}
    \item version (optional, default="ignoring"): version of the MH algorithm. Options: ignoring, refl\_bound, aggr
    \item sd\_transition\_factor (optional, default=6): the standard deviation factor of the transition kernel. The standard deviation is given by (upper bound - lower bound) / sd\_transition\_factor
    \item likelihood\_sd (optional, default=1): the standard deviation parameter for independent likelihood function, or the standard deviation parameter factor for dependent likelihood function (standard deviation: likelihood\_sd * y\_error)
    \item likelihood\_dependence (optional, required if likelihood\_sd is present, default=False): to select whether to use the dependent likelihood function or the independent likelihood function
    \item max\_probability (optional, default=False): the acceptance rate will take the maximum probability value of the acceptance rate array if set true, otherwise the mean
    \item iterations (optional, default=10000): number of iterations
    \item init\_method (optional, default="random"): specify the starting state of the Dream MCMC algorithm. Options: random, min, max, q1\_prior, mean\_prior, q3\_prior, q1\_posterior, median\_posterior, q3\_posterior
\end{itemize}

Configurations for the parallel Metropolis-Hastings algorithm include:
\begin{itemize}
    \item version (optional, default="ignoring"): version of the MH algorithm. Options: ignoring, refl\_bound, aggr
    \item chains (optional, default=4): number of chains
    \item sd\_transition\_factor (optional, default=6): the
    standard deviation factor of the transition kernel. The standard deviation is given by (upper bound - lower bound) / sd\_transition\_factor
    \item likelihood\_sd (optional, default=1): the standard deviation parameter for independent likelihood function, or the standard deviation parameter factor for dependent likelihood function (standard deviation: likelihood\_sd * y\_error).
    \item likelihood\_dependence (optional, required if likelihood\_sd is present, default=False): to select whether to use the dependent likelihood function or the independent likelihood function
    \item max\_probability (optional, default=False): the acceptance rate will take the maximum probability value of the acceptance rate array if set true, otherwise the mean
    \item iterations (optional, default=2500): number of iterations
    \item init\_method (optional, default="random"): specify the starting state of the Dream MCMC algorithm. Options: random, min, max, q1\_prior, mean\_prior, q3\_prior, q1\_posterior, median\_posterior, q3\_posterior
\end{itemize}

Configurations for the general parallel Metropolis-Hastings algorithm include:
\begin{itemize}
    \item num\_proposals (optional, default=8): the numbers of proposal points in each iteration
    \item num\_accepted (optional, default=4): the numbers of accepted points in each iteration
    \item likelihood\_sd (optional, default=1): the standard deviation parameter for independent likelihood function, or the standard deviation parameter factor for dependent likelihood function (standard deviation: likelihood\_sd * y\_error).
    \item likelihood\_dependence (optional, required if likelihood\_sd is present, default=False): to select whether to use the dependent likelihood function or the independent likelihood function
    \item sd\_transition\_factor (optional, default=6): the standard deviation factor of the transition kernel. The standard deviation is given by (upper bound - lower bound) / sd\_transition\_factor
    \item version (optional, default="ignoring"): version of the MH algorithm. Options: ignoring, refl\_bound, aggr
    \item iterations (optional, default=2500): number of iterations
    \item init\_method (optional, default="random"): specify the starting state of the Dream MCMC algorithm. Options: random, min, max, q1\_prior, mean\_prior, q3\_prior, q1\_posterior, median\_posterior, q3\_posterior
\end{itemize}

Configurations for the DREAM algorithm include\footnote{More information regarding specifications can be found on https://pydream.readthedocs.io/en/latest/pydream.html}:
\begin{itemize}
    \item iterations (optional, default=1250): number of iterations
\item chains (optional, default=8): number of chains
\item DEpairs (optional, default=1)
\item multitry (optional, default=False)
\item hardboundaries (optional, default=True)
\item crossover\_burnin (optional, default=0)
\item nCR (optional, default=3)
\item snooker (optional, default=0)
\item p\_gamma\_unity (optional, default=0)
\item init\_method (optional, default="random"): specify the starting state of the Dream MCMC algorithm. Options: random, min, max, q1\_prior, mean\_prior, q3\_prior, q1\_posterior, median\_posterior, q3\_posterior
\item likelihood\_sd (optional, default=1): the standard deviation parameter for independent likelihood function, or the standard deviation parameter factor for dependent likelihood function (standard deviation: likelihood\_sd * y\_error).
\item likelihood\_dependence (optional, required if likelihood\_sd is present, default=False): to select whether to use the dependent likelihood function or the independent likelihood function  
\end{itemize}
